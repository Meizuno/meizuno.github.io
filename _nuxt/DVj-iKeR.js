import{y as R,M as j,co as $,al as G,r as w,o as M,R as x,c as Y,ao as L,a9 as b,c2 as F,dq as T,dr as V,I as W,e as Z,w as H,Z as Q,aR as X,n as ee,G as P,ab as te,ds as U,a6 as z,dt as ae}from"./DGj4R93x.js";import{f as re}from"./CoZXIdKY.js";function ne(t){return t.validate&&t.__isYupSchema__}function se(t){return t.inner!==void 0}function ie(t){return"schema"in t&&typeof t.coercer=="function"&&typeof t.validator=="function"&&typeof t.refiner=="function"}function oe(t){return t.validateAsync!==void 0&&t.id!==void 0}function le(t){return t.isJoi===!0}function ue(t){return"~standard"in t}async function ce(t,n){const s=await n["~standard"].validate(t);return s.issues?{errors:s.issues?.map(a=>({name:a.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:a.message}))||[],result:null}:{errors:null,result:s.value}}async function de(t,n){try{return{errors:null,result:await n.validate(t,{abortEarly:!1})}}catch(s){if(se(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function fe(t,n){const[s,a]=n.validate(t);return s?{errors:s.failures().map(S=>({message:S.message,name:S.path.join(".")})),result:null}:{errors:null,result:a}}async function me(t,n){try{return{errors:null,result:await n.validateAsync(t,{abortEarly:!1})}}catch(s){if(le(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function pe(t,n){if(ue(n))return ce(t,n);if(oe(n))return me(t,n);if(ne(n))return de(t,n);if(ie(n))return fe(t,n);throw new Error("Form validation failed: Unsupported form schema")}class g extends Error{formId;errors;children;constructor(n,s,a){super("Form validation exception"),this.formId=n,this.errors=s,this.children=a,Object.setPrototypeOf(this,g.prototype)}}const ye={base:""},we={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(t,{expose:n,emit:s}){const a=t,o=s,S=R(),N=j(()=>z({extend:z(ye),...S.ui?.form||{}})),c=a.id??$(),O=re(`form-${c}`),d=a.attach&&G(U,void 0);b(U,O);const _=w(new Map);M(async()=>{O.on(async e=>{e.type==="attach"?_.value.set(e.formId,{validate:e.validate}):e.type==="detach"?_.value.delete(e.formId):a.validateOn?.includes(e.type)&&!u.value&&(e.type!=="input"?await f({name:e.name,silent:!0,nested:!1}):(e.eager||A.has(e.name))&&await f({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&A.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&C.add(e.name),(e.type==="change"||e.type==="input")&&I.add(e.name)})}),Y(()=>{O.reset()}),M(async()=>{d&&(await L(),d.emit({type:"attach",validate:f,formId:c}))}),Y(()=>{d&&d.emit({type:"detach",formId:c})});const i=w([]);b("form-errors",i);const E=w({});b(ae,E);const I=x(new Set),C=x(new Set),A=x(new Set);function B(e){return e.map(r=>({...r,id:r?.name?E.value[r.name]?.id:void 0}))}const k=w(null);async function D(){let e=a.validate?await a.validate(a.state)??[]:[];if(a.schema){const{errors:r,result:l}=await pe(a.state,a.schema);r?e=e.concat(r):k.value=l}return B(e)}async function f(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!r&&e.nested?Array.from(_.value.values()).map(({validate:m})=>m(e).then(()=>{}).catch(p=>{if(!(p instanceof g))throw p;return p})):[];if(r){const m=i.value.filter(y=>!r.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)})),p=(await D()).filter(y=>r.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)}));i.value=m.concat(p)}else i.value=await D();const q=(await Promise.all(l)).filter(m=>m!==void 0);if(i.value.length+q.length>0){if(e.silent)return!1;throw new g(c,i.value,q)}return e.transform&&Object.assign(a.state,k.value),a.state}const u=w(!1);b(T,F(u));async function J(e){u.value=a.loadingAuto&&!0;const r=e;try{r.data=await f({nested:!0,transform:a.transform}),await a.onSubmit?.(r),I.clear()}catch(l){if(!(l instanceof g))throw l;const q={...r,errors:l.errors,children:l.children};o("error",q)}finally{u.value=!1}}const K=j(()=>a.disabled||u.value);return b(V,j(()=>({disabled:K.value,validateOnInputDelay:a.validateOnInputDelay}))),n({validate:f,errors:i,setErrors(e,r){r?i.value=i.value.filter(l=>l.name!==r).concat(B(e)):i.value=B(e)},async submit(){await J(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:K,loading:u,dirty:j(()=>!!I.size),dirtyFields:F(I),blurredFields:F(A),touchedFields:F(C)}),(e,r)=>(Z(),W(te(P(d)?"div":"form"),{id:P(c),class:ee(N.value({class:a.class})),onSubmit:X(J,["prevent"])},{default:H(()=>[Q(e.$slots,"default",{errors:i.value,loading:u.value})]),_:3},40,["id","class"]))}};export{we as default};
