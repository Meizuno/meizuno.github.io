import{y as V,I as j,cI as W,af as $,r as w,o as K,N as x,c as M,ai as G,aa as b,aY as F,dq as L,dr as T,V as H,e as Q,w as R,W as X,aP as Z,n as ee,G as P,aM as ae,ds as N,a7 as U,dt as te}from"./C3y5PP2h.js";import{f as re}from"./gu16_CE3.js";function ne(a){return a.validate&&a.__isYupSchema__}function se(a){return a.inner!==void 0}function ie(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function oe(a){return a.validateAsync!==void 0&&a.id!==void 0}function le(a){return a.isJoi===!0}function ue(a){return"~standard"in a}async function de(a,n){const s=await n["~standard"].validate(a);return s.issues?{errors:s.issues?.map(t=>({name:t.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:t.message}))||[],result:null}:{errors:null,result:s.value}}async function ce(a,n){try{return{errors:null,result:await n.validate(a,{abortEarly:!1})}}catch(s){if(se(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function fe(a,n){const[s,t]=n.validate(a);return s?{errors:s.failures().map(S=>({message:S.message,name:S.path.join(".")})),result:null}:{errors:null,result:t}}async function me(a,n){try{return{errors:null,result:await n.validateAsync(a,{abortEarly:!1})}}catch(s){if(le(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function pe(a,n){if(ue(n))return de(a,n);if(oe(n))return me(a,n);if(ne(n))return ce(a,n);if(ie(n))return fe(a,n);throw new Error("Form validation failed: Unsupported form schema")}class g extends Error{formId;errors;children;constructor(n,s,t){super("Form validation exception"),this.formId=n,this.errors=s,this.children=t,Object.setPrototypeOf(this,g.prototype)}}const ye={base:""},we={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:n,emit:s}){const t=a,o=s,S=V(),z=j(()=>U({extend:U(ye),...S.ui?.form||{}})),d=t.id??W(),O=re(`form-${d}`),c=t.attach&&$(N,void 0);b(N,O);const _=w(new Map);K(async()=>{O.on(async e=>{e.type==="attach"?_.value.set(e.formId,{validate:e.validate}):e.type==="detach"?_.value.delete(e.formId):t.validateOn?.includes(e.type)&&!u.value&&(e.type!=="input"?await f({name:e.name,silent:!0,nested:!1}):(e.eager||A.has(e.name))&&await f({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&A.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&C.add(e.name),(e.type==="change"||e.type==="input")&&E.add(e.name)})}),M(()=>{O.reset()}),K(async()=>{c&&(await G(),c.emit({type:"attach",validate:f,formId:d}))}),M(()=>{c&&c.emit({type:"detach",formId:d})});const i=w([]);b("form-errors",i);const I=w({});b(te,I);const E=x(new Set),C=x(new Set),A=x(new Set);function B(e){return e.map(r=>({...r,id:r?.name?I.value[r.name]?.id:void 0}))}const Y=w(null);async function k(){let e=t.validate?await t.validate(t.state)??[]:[];if(t.schema){const{errors:r,result:l}=await pe(t.state,t.schema);r?e=e.concat(r):Y.value=l}return B(e)}async function f(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!r&&e.nested?Array.from(_.value.values()).map(({validate:m})=>m(e).then(()=>{}).catch(p=>{if(!(p instanceof g))throw p;return p})):[];if(r){const m=i.value.filter(y=>!r.some(v=>{const h=I.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)})),p=(await k()).filter(y=>r.some(v=>{const h=I.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)}));i.value=m.concat(p)}else i.value=await k();const q=(await Promise.all(l)).filter(m=>m!==void 0);if(i.value.length+q.length>0){if(e.silent)return!1;throw new g(d,i.value,q)}return e.transform&&Object.assign(t.state,Y.value),t.state}const u=w(!1);b(L,F(u));async function D(e){u.value=t.loadingAuto&&!0;const r=e;try{r.data=await f({nested:!0,transform:t.transform}),await t.onSubmit?.(r),E.clear()}catch(l){if(!(l instanceof g))throw l;const q={...r,errors:l.errors,children:l.children};o("error",q)}finally{u.value=!1}}const J=j(()=>t.disabled||u.value);return b(T,j(()=>({disabled:J.value,validateOnInputDelay:t.validateOnInputDelay}))),n({validate:f,errors:i,setErrors(e,r){r?i.value=i.value.filter(l=>l.name!==r).concat(B(e)):i.value=B(e)},async submit(){await D(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:J,loading:u,dirty:j(()=>!!E.size),dirtyFields:F(E),blurredFields:F(A),touchedFields:F(C)}),(e,r)=>(Q(),H(ae(P(c)?"div":"form"),{id:P(d),class:ee(z.value({class:t.class})),onSubmit:Z(D,["prevent"])},{default:R(()=>[X(e.$slots,"default",{errors:i.value,loading:u.value})]),_:3},40,["id","class"]))}};export{we as default};
