import{y as $,M as j,cn as G,al as L,r as w,o as M,U as x,c as U,ao as R,aa as b,c1 as F,dq as T,dr as V,I as W,e as H,w as Q,a0 as X,aR as Z,n as ee,G as Y,ac as ae,ds as P,a7 as z,dt as te}from"./D2I4l5jL.js";import{f as re}from"./DZ-sLTMd.js";function ne(a){return a.validate&&a.__isYupSchema__}function se(a){return a.inner!==void 0}function ie(a){return"schema"in a&&typeof a.coercer=="function"&&typeof a.validator=="function"&&typeof a.refiner=="function"}function oe(a){return a.validateAsync!==void 0&&a.id!==void 0}function le(a){return a.isJoi===!0}function ue(a){return"~standard"in a}async function ce(a,n){const s=await n["~standard"].validate(a);return s.issues?{errors:s.issues?.map(t=>({name:t.path?.map(o=>typeof o=="object"?o.key:o).join(".")||"",message:t.message}))||[],result:null}:{errors:null,result:s.value}}async function de(a,n){try{return{errors:null,result:await n.validate(a,{abortEarly:!1})}}catch(s){if(se(s))return{errors:s.inner.map(o=>({name:o.path??"",message:o.message})),result:null};throw s}}async function fe(a,n){const[s,t]=n.validate(a);return s?{errors:s.failures().map(S=>({message:S.message,name:S.path.join(".")})),result:null}:{errors:null,result:t}}async function me(a,n){try{return{errors:null,result:await n.validateAsync(a,{abortEarly:!1})}}catch(s){if(le(s))return{errors:s.details.map(o=>({name:o.path.join("."),message:o.message})),result:null};throw s}}function pe(a,n){if(ue(n))return ce(a,n);if(oe(n))return me(a,n);if(ne(n))return de(a,n);if(ie(n))return fe(a,n);throw new Error("Form validation failed: Unsupported form schema")}class g extends Error{formId;errors;children;constructor(n,s,t){super("Form validation exception"),this.formId=n,this.errors=s,this.children=t,Object.setPrototypeOf(this,g.prototype)}}const ye={base:""},we={__name:"UForm",props:{id:{type:[String,Number],required:!1},schema:{type:null,required:!1},state:{type:Object,required:!0},validate:{type:Function,required:!1},validateOn:{type:Array,required:!1,default(){return["input","blur","change"]}},disabled:{type:Boolean,required:!1},validateOnInputDelay:{type:Number,required:!1,default:300},transform:{type:null,required:!1,default:()=>!0},attach:{type:Boolean,required:!1,default:!0},loadingAuto:{type:Boolean,required:!1,default:!0},class:{type:null,required:!1},onSubmit:{type:Function,required:!1}},emits:["submit","error"],setup(a,{expose:n,emit:s}){const t=a,o=s,S=$(),N=j(()=>z({extend:z(ye),...S.ui?.form||{}})),c=t.id??G(),O=re(`form-${c}`),d=t.attach&&L(P,void 0);b(P,O);const _=w(new Map);M(async()=>{O.on(async e=>{e.type==="attach"?_.value.set(e.formId,{validate:e.validate}):e.type==="detach"?_.value.delete(e.formId):t.validateOn?.includes(e.type)&&!u.value&&(e.type!=="input"?await f({name:e.name,silent:!0,nested:!1}):(e.eager||A.has(e.name))&&await f({name:e.name,silent:!0,nested:!1})),e.type==="blur"&&A.add(e.name),(e.type==="change"||e.type==="input"||e.type==="blur"||e.type==="focus")&&C.add(e.name),(e.type==="change"||e.type==="input")&&I.add(e.name)})}),U(()=>{O.reset()}),M(async()=>{d&&(await R(),d.emit({type:"attach",validate:f,formId:c}))}),U(()=>{d&&d.emit({type:"detach",formId:c})});const i=w([]);b("form-errors",i);const E=w({});b(te,E);const I=x(new Set),C=x(new Set),A=x(new Set);function B(e){return e.map(r=>({...r,id:r?.name?E.value[r.name]?.id:void 0}))}const k=w(null);async function D(){let e=t.validate?await t.validate(t.state)??[]:[];if(t.schema){const{errors:r,result:l}=await pe(t.state,t.schema);r?e=e.concat(r):k.value=l}return B(e)}async function f(e={silent:!1,nested:!0,transform:!1}){const r=e.name&&!Array.isArray(e.name)?[e.name]:e.name,l=!r&&e.nested?Array.from(_.value.values()).map(({validate:m})=>m(e).then(()=>{}).catch(p=>{if(!(p instanceof g))throw p;return p})):[];if(r){const m=i.value.filter(y=>!r.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)})),p=(await D()).filter(y=>r.some(v=>{const h=E.value?.[v]?.pattern;return v===y.name||h&&y.name?.match(h)}));i.value=m.concat(p)}else i.value=await D();const q=(await Promise.all(l)).filter(m=>m!==void 0);if(i.value.length+q.length>0){if(e.silent)return!1;throw new g(c,i.value,q)}return e.transform&&Object.assign(t.state,k.value),t.state}const u=w(!1);b(T,F(u));async function J(e){u.value=t.loadingAuto&&!0;const r=e;try{r.data=await f({nested:!0,transform:t.transform}),await t.onSubmit?.(r),I.clear()}catch(l){if(!(l instanceof g))throw l;const q={...r,errors:l.errors,children:l.children};o("error",q)}finally{u.value=!1}}const K=j(()=>t.disabled||u.value);return b(V,j(()=>({disabled:K.value,validateOnInputDelay:t.validateOnInputDelay}))),n({validate:f,errors:i,setErrors(e,r){r?i.value=i.value.filter(l=>l.name!==r).concat(B(e)):i.value=B(e)},async submit(){await J(new Event("submit"))},getErrors(e){return e?i.value.filter(r=>r.name===e):i.value},clear(e){e?i.value=i.value.filter(r=>r.name!==e):i.value=[]},disabled:K,loading:u,dirty:j(()=>!!I.size),dirtyFields:F(I),blurredFields:F(A),touchedFields:F(C)}),(e,r)=>(H(),W(ae(Y(d)?"div":"form"),{id:Y(c),class:ee(N.value({class:t.class})),onSubmit:Z(J,["prevent"])},{default:Q(()=>[X(e.$slots,"default",{errors:i.value,loading:u.value})]),_:3},40,["id","class"]))}};export{we as default};
